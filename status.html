<!DOCTYPE html>
<html>
<head>
<title>Google Status</title>
<script>

    var pollIntervalMin = 1000 * 5;  // 5 seconds
    var pollIntervalMax = 1000 * 60 * 60;  // 1 hour
    var requestFailureCount = 0;  // used for exponential backoff
    var requestTimeout = 1000 * 5;  // 5 seconds

    var username;

    // false = logged off
    // true = logged in
    var googleStatus = false;

    function showLoggedIn() {
        changeIcon(safari.extension.baseURI + "google_in.png");
    }

    function showLoggedOut() {
        changeIcon(safari.extension.baseURI + "google_out.png");
    }

    function changeIcon(img) {

        var itemArray = safari.extension.toolbarItems;
        for (var i = 0; i < itemArray.length; ++i) {
            var item = itemArray[i];
            if (item.identifier.search(/\bgoogle-status/) > -1) {
                item.image = img;
                item.toolTip = username || "Not logged in";
            }
        }
    }

    function startRequest() {

        getCurrentUser( function (un) {

            username = un;
            // if the user is logged in
            if (un !== undefined) {
                if (!googleStatus) {
                    showLoggedIn();
                    googleStatus = true;
                }
            } else {
                if (googleStatus) {
                    showLoggedOut();
                    googleStatus = false;
                }
            }
            scheduleRequest();
        });
    }

    function scheduleRequest() {
      var randomness = Math.random() * 2;
      var exponent = Math.pow(2, requestFailureCount);
      var delay = Math.min(randomness * pollIntervalMin * exponent, pollIntervalMax);
      delay = Math.round(delay);

      window.setTimeout(startRequest, delay);
    }



    function sendXHR(url, successHandler) {

        var xhr = new XMLHttpRequest();

        var abortTimerId = window.setTimeout(function() {
           xhr.abort();
         }, requestTimeout);

         function handleSuccess() {
           requestFailureCount = 0;
           window.clearTimeout(abortTimerId);
           if (successHandler !== undefined) {
               successHandler(xhr);
           }
         }

         function handleError() {
           ++requestFailureCount;
           window.clearTimeout(abortTimerId);
         }


        xhr.onreadystatechange = function(data) {
            if (xhr.readyState === 4) {
                handleSuccess();
            }
        };

        xhr.onerror = function(error) {
             handleError();
        };


        xhr.open('GET', url, true);
        xhr.send();
    }

    /**
     * It returns the logged user's loginname
     * @param callback
     */
    function getCurrentUser(callback) {

        var currentUser;

        sendXHR('http://www.google.com/', function (xhr) {
            if (xhr.status === 200) {
                var re = new RegExp(/<b class="?gb4"?>[\s]*([^<]+@[^<]+)<\/b>/i),
                    m = re.exec(xhr.responseText);
                if (m && m.length == 2) {
                        currentUser = m[1];
                }
            }

            // we have a response anyway
            if (callback !== undefined) {
                callback(currentUser);
            }
        });
    }

    function init() {
        // default is logged off
        showLoggedOut();
        googleStatus = false;
        startRequest();
    }


    function performCommand(event)  {
        // no action yet
    }

    function validateCommand(event) {
        return true;
    }

    safari.application.addEventListener("command", performCommand, false);
    safari.application.addEventListener("validate", validateCommand, false);

    init();

</script>

</head>
<body>
</body>
</html>